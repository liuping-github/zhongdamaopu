{"version":3,"sources":["index.js","cloud.js","request/request.js","types.js","request/request-uni.js","request/request-wxmp.js","request/index.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;ACFA,ADGA;ACFA,ADGA;ACFA,ADGA;ACFA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA,ACHA;AFOA,ADGA,AENA,ACHA;AFOA,ADGA,AENA,ACHA;AFOA,ADGA,AIZA,AFMA,ACHA;AFOA,ADGA,AIZA,AFMA,ACHA;AFOA,ADGA,AIZA,AFMA,ACHA;AFOA,AGTA,ACHA,AHSA,ACHA;AFOA,AGTA,ACHA,AHSA,ACHA;AFOA,AGTA,ACHA,AHSA,ACHA;AFOA,AKfA,AFMA,ACHA,AHSA;ADIA,AKfA,AFMA,ACHA,AHSA;ADIA,AKfA,AFMA,ACHA,AHSA;ADIA,AKfA,AFMA,ACHA,AHSA;ADIA,AKfA,AFMA,ACHA,AHSA;ADIA,AKfA,AFMA,ACHA,AHSA;ADIA,AKfA,AFMA,ACHA,AHSA;ADIA,AKfA,AFMA,ACHA,AHSA;ADIA,AKfA,AFMA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AGTA,ACHA,AHSA;ADIA,AIZA,AHSA;ADIA,AIZA,AHSA;ADIA,AIZA,AHSA;ADIA,AIZA,AHSA;ADIA,AIZA,AHSA;ADIA,AIZA,AHSA;ADIA,AIZA,AHSA;ADIA,AIZA,AHSA;ADIA,AIZA,AHSA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["\nfunction __export(m) {\n    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];\n}\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst cloud_1 = require(\"./cloud\");\nexports.Cloud = cloud_1.Cloud;\nexports.Db = cloud_1.Db;\n__export(require(\"./request\"));\n__export(require(\"./types\"));\nfunction init(config) {\n    return new cloud_1.Cloud(config);\n}\nexports.init = init;\n//# sourceMappingURL=index.js.map","\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst database_ql_1 = require(\"database-ql\");\nexports.Db = database_ql_1.Db;\nconst request_1 = require(\"./request/request\");\nexports.Request = request_1.Request;\nconst request_uni_1 = require(\"./request/request-uni\");\nconst request_wxmp_1 = require(\"./request/request-wxmp\");\nconst types_1 = require(\"./types\");\n/**\n * class Cloud provide the interface to request cloud function and cloud database.\n */\nclass Cloud {\n    /**\n     * Create a cloud instance\n     * @param config\n     */\n    constructor(config) {\n        const warningFunc = () => {\n            console.warn('WARNING: no getAccessToken set for db proxy request');\n            return \"\";\n        };\n        this.config = {\n            baseUrl: config.baseUrl,\n            dbProxyUrl: config.dbProxyUrl,\n            getAccessToken: (config === null || config === void 0 ? void 0 : config.getAccessToken) || warningFunc,\n            environment: (config === null || config === void 0 ? void 0 : config.environment) || types_1.EnvironmentType.H5,\n            primaryKey: config === null || config === void 0 ? void 0 : config.primaryKey,\n            timeout: config === null || config === void 0 ? void 0 : config.timeout,\n            headers: config === null || config === void 0 ? void 0 : config.headers,\n            requestClass: config === null || config === void 0 ? void 0 : config.requestClass\n        };\n        const reqClass = this.requestClass;\n        this._request = new reqClass(this.config);\n    }\n    /**\n     * request class by environment\n     */\n    get requestClass() {\n        var _a, _b, _c;\n        const env = (_a = this.config) === null || _a === void 0 ? void 0 : _a.environment;\n        let ret = request_1.Request;\n        if ((_b = this.config) === null || _b === void 0 ? void 0 : _b.requestClass) {\n            ret = (_c = this.config) === null || _c === void 0 ? void 0 : _c.requestClass;\n        }\n        else if (env === types_1.EnvironmentType.UNI_APP) {\n            ret = request_uni_1.UniRequest;\n        }\n        else if (env === types_1.EnvironmentType.WX_MP) {\n            ret = request_wxmp_1.WxmpRequest;\n        }\n        else {\n            ret = request_1.Request;\n        }\n        return ret;\n    }\n    /**\n     * Get a cloud database instance\n     * @returns\n     */\n    database() {\n        var _a;\n        return new database_ql_1.Db({\n            request: this._request,\n            primaryKey: (_a = this.config) === null || _a === void 0 ? void 0 : _a.primaryKey\n        });\n    }\n    /**\n     * Invoke cloud function by name use POST http method\n     * @alias alias of `invoke()` for history reason\n     * @param functionName\n     * @param data\n     * @returns\n     */\n    async invokeFunction(functionName, data) {\n        const url = this.config.baseUrl + `/${functionName}`;\n        const res = await this\n            ._request\n            .request(url, data);\n        return res.data;\n    }\n    /**\n     * Invoke cloud function by name use POST http method\n     * @param functionName\n     * @param data\n     * @returns\n     */\n    async invoke(functionName, data) {\n        return await this.invokeFunction(functionName, data);\n    }\n}\nexports.Cloud = Cloud;\n//# sourceMappingURL=cloud.js.map","\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst axios_1 = require(\"axios\");\nconst types_1 = require(\"../types\");\n/**\n * 默认使用 axios 发送请求，可支持浏览器 和 Node.js 环境，如需支持其它平台，请派生子类并重写 `send()` 方法\n */\nclass Request {\n    constructor(options) {\n        this.options = Object.assign({}, options);\n        this.options.timeout = (options === null || options === void 0 ? void 0 : options.timeout) || 15000;\n    }\n    /**\n     * 发送 less-api 数据操作请求, 由 `Db` 中调用\n     * @param action\n     * @param data\n     * @returns\n     */\n    async send(action, data) {\n        const params = Object.assign({}, data, {\n            action\n        });\n        const slowQueryWarning = setTimeout(() => {\n            console.warn('Database operation is longer than 3s. Please check query performance and your network environment.');\n        }, 3000);\n        try {\n            const req_url = this.options.baseUrl + this.options.dbProxyUrl;\n            const res = await this.request(req_url, params);\n            return res.data;\n        }\n        finally {\n            clearTimeout(slowQueryWarning);\n        }\n    }\n    /**\n     * 发出 HTTP 请求，主要于 `less-api` 数据请求和 `less-framework` 云函数调用时使用\n     * 默认使用 axios 发送请求，可支持浏览器 和 Node.js 环境，如需支持其它平台，请派生子类并重写本方法\n     * @param data\n     * @returns\n     */\n    async request(url, data) {\n        if (this.options.environment !== types_1.EnvironmentType.H5) {\n            throw new Error('environment type must be h5');\n        }\n        const token = this.options.getAccessToken();\n        const headers = this.getHeaders(token);\n        const res = await axios_1.default\n            .post(url, data, {\n            headers,\n            timeout: this.options.timeout,\n        });\n        return res;\n    }\n    /**\n     * 获取必要的请求头\n     * @param token\n     * @returns\n     */\n    getHeaders(token, headers) {\n        var _a;\n        headers = headers !== null && headers !== void 0 ? headers : { 'Content-Type': 'application/json' };\n        if (token) {\n            headers['Authorization'] = `Bearer ${token}`;\n        }\n        const optionHeader = ((_a = this.options) === null || _a === void 0 ? void 0 : _a.headers) || {};\n        return Object.assign(headers, optionHeader);\n    }\n}\nexports.Request = Request;\n//# sourceMappingURL=request.js.map","\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar EnvironmentType;\n(function (EnvironmentType) {\n    EnvironmentType[\"H5\"] = \"h5\";\n    EnvironmentType[\"WX_MP\"] = \"wxmp\";\n    EnvironmentType[\"UNI_APP\"] = \"uniapp\";\n})(EnvironmentType = exports.EnvironmentType || (exports.EnvironmentType = {}));\n//# sourceMappingURL=types.js.map","\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst request_1 = require(\"./request\");\nconst types_1 = require(\"../types\");\n/**\n * Uni-app 环境请求类\n */\nclass UniRequest extends request_1.Request {\n    constructor(config) {\n        super(config);\n    }\n    /**\n     * uni-app 环境请求方法\n     * @override\n     * @param data\n     * @returns\n     */\n    async request(url, data, _options) {\n        var _a;\n        if (this.options.environment !== types_1.EnvironmentType.UNI_APP) {\n            throw new Error('environment type must be uniapp');\n        }\n        const token = this.options.getAccessToken();\n        const header = this.getHeaders(token);\n        const options = {\n            url,\n            header,\n            method: (_a = _options === null || _options === void 0 ? void 0 : _options.method) !== null && _a !== void 0 ? _a : 'POST',\n            data,\n            dataType: 'json'\n        };\n        const res = await uni.request(options);\n        return res;\n    }\n}\nexports.UniRequest = UniRequest;\n//# sourceMappingURL=request-uni.js.map","\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst types_1 = require(\"../types\");\nconst request_1 = require(\"./request\");\n/**\n * 微信小程序环境请求类\n */\nclass WxmpRequest extends request_1.Request {\n    constructor(config) {\n        super(config);\n    }\n    /**\n     * 微信小程序环境请求方法\n     * @override\n     * @param data\n     * @returns\n     */\n    async request(url, data, _options) {\n        var _a;\n        if (this.options.environment !== types_1.EnvironmentType.WX_MP) {\n            throw new Error('environment type must be wxmp');\n        }\n        const token = this.options.getAccessToken();\n        const header = this.getHeaders(token);\n        const options = {\n            url,\n            header,\n            method: (_a = _options === null || _options === void 0 ? void 0 : _options.method) !== null && _a !== void 0 ? _a : 'POST',\n            data,\n            dataType: 'json'\n        };\n        return new Promise((resolve, reject) => {\n            wx.request(Object.assign(Object.assign({}, options), { success(res) {\n                    resolve(res);\n                },\n                fail(err) {\n                    reject(err);\n                } }));\n        });\n    }\n}\nexports.WxmpRequest = WxmpRequest;\n//# sourceMappingURL=request-wxmp.js.map","\nfunction __export(m) {\n    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];\n}\nObject.defineProperty(exports, \"__esModule\", { value: true });\n__export(require(\"./request\"));\n__export(require(\"./request-uni\"));\n__export(require(\"./request-wxmp\"));\n//# sourceMappingURL=index.js.map"]}